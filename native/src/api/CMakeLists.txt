include(gen_api_file)

# Config
set(API_TARGET clari)
set(API_SOURCE "${CMAKE_CURRENT_SOURCE_DIR}/autogen.cpp")

# API source file name
# Include binary dir path to avoid clobbering other CMakes
string(MD5 BD_HASH "${CMAKE_CURRENT_BINARY_DIR}")
message("API autogen source file will be: ${API_SOURCE}")

# Headers
set(HEADERS
    "${CMAKE_CURRENT_SOURCE_DIR}/manual.hpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/headers.hpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/constants.hpp"
)

# Gen API files
gen_api_file(
    "${API_TARGET}"
    "${API_SOURCE}"
    "${CMAKE_CURRENT_SOURCE_DIR}/binder/"
    ${HEADERS}
)

# Configure target
message(STATUS "Configuring API target...")
pybind11_add_module("${API_TARGET}")
target_include_directories("${API_TARGET}" SYSTEM BEFORE PUBLIC "${Z3_INCLUDE_DIR}" PUBLIC ${Boost_INCLUDE_DIRS})
target_link_libraries("${API_TARGET}" PUBLIC "${CLARICPP}" PUBLIC "${Z3_LINK_TARGET}" PUBLIC "${GMP_LIBRARIES}")
# TODO: these target_ functions should be inherited from claricpp... why aren't they?
target_sources(clari PRIVATE "${API_SOURCE}"
    py_shim_code.cpp
    exceptions.cpp
    signal_handler.cpp
    simplify.cpp
    manual.cpp
    log.cpp
)

# Code quality exceptions for auto-generated code
message(STATUS "Permitting and suppressing warnings for auto-generated code...")
set_source_files_properties(${API_SOURCE} PROPERTIES COMPILE_FLAGS "-Wno-error -w")
message("Autogenerated API code configured!")

# Clean file
set_property(TARGET "${API_TARGET}"
    APPEND PROPERTY ADDITIONAL_CLEAN_FILES
    "${API_SOURCE}"
)