include(gen_api_file)

# Config
set(API_TARGET clari)
set(AUTOGEN_DIR "${CMAKE_CURRENT_SOURCE_DIR}/autogen/")

# API source file name
# Include binary dir path to avoid clobbering other CMakes
string(MD5 BD_HASH "${CMAKE_CURRENT_BINARY_DIR}")
set(API_SOURCE "${AUTOGEN_DIR}/cmake/api.${BD_HASH}.cpp")
message("API source file will be: ${API_SOURCE}")

# Gen API files
gen_api_file(
    "${API_SOURCE}"
    "${AUTOGEN_DIR}/binder/"
    "${CMAKE_CURRENT_SOURCE_DIR}/manual.hpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/headers.hpp"
)

# Configure target
message(STATUS "Configuring API target...")
pybind11_add_module("${API_TARGET}")
target_sources(clari PRIVATE "${API_SOURCE}" manual.cpp)
target_include_directories("${API_TARGET}" SYSTEM BEFORE PRIVATE ${Boost_INCLUDE_DIRS})
target_link_libraries("${API_TARGET}" PUBLIC "${CLARICPP}" PUBLIC "${Z3_LINK_TARGET}" PUBLIC "${GMP_LIBRARIES}")

# Code quality exceptions for auto-generated code
message(STATUS "Permitting and suppressing warnings for auto-generated code...")
set_source_files_properties(${API_SOURCE} PROPERTIES COMPILE_FLAGS "-Wno-error -w")
message("Autogenerated API code configured!")

# Clean file
set_property(TARGET "${API_TARGET}"
    APPEND PROPERTY ADDITIONAL_CLEAN_FILES
    "${API_SOURCE}"
)