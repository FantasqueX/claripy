# Config
set(API_TARGET clari)
pybind11_add_module("${API_TARGET}")

# Skip generation
set(API_SOURCE "${CMAKE_CURRENT_SOURCE_DIR}/merged.cpp")
if (NOT EXISTS "${API_SOURCE}")
    message(STATUS "Auto-generating API code")

    # Clean file
    set(BINDER_DIR "${CMAKE_CURRENT_SOURCE_DIR}/binder")
    set_property(TARGET "${API_TARGET}" APPEND PROPERTY ADDITIONAL_CLEAN_FILES "${BINDER_DIR}")

    # Remove bad auto-gen'd code
    if (EXISTS "${BINDER_DIR}/std")
        message(STATUS "Removing auto-generated STL bindings...")
        file(REMOVE_RECURSE "${BINDER_DIR}/std")
    endif()

    # Temp file
    set(WRITE_OUT "// Claricpp API\n")

    # Strip out std stuff
    message(STATUS "Generating main source code...")
    file(STRINGS "${BINDER_DIR}/clari.cpp" LINES)
    foreach(LINE IN LISTS LINES)
        if (NOT "${LINE}" MATCHES "bind_std")
            string(APPEND WRITE_OUT "${LINE}\n")
        endif()
    endforeach()

    function(gen_fname FPATH)
        get_filename_component(FPATH "${FPATH}" ABSOLUTE)
        string(LENGTH "${CMAKE_CURRENT_SOURCE_DIR}" PLEN)
        math(EXPR PLEN "${PLEN}+1")
        string(SUBSTRING "${FPATH}" "${PLEN}" -1 FNAME)
        set(FNAME "//\n${PREFIX}// File: ${FNAME}\n//\n" PARENT_SCOPE)
    endfunction()

    # Add source files
    message(STATUS "Merging auto-generated source files...")
    file(GLOB SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/binder/*/*.cpp")
    foreach(N_SOURCE IN LISTS SOURCES)
        gen_fname("${N_SOURCE}")
        file(READ ${N_SOURCE} CONTENTS)
        string(APPEND WRITE_OUT "\n\n${FNAME}\n${CONTENTS}\n")
    endforeach()

    # Complete source file: rename seems to be buggy?
    message(STATUS "Writing out auto-gen'd API code file")
    file(WRITE "${API_SOURCE}" "${WRITE_OUT}")
endif()

# Configure target
message(STATUS "Configure API target...")
target_sources(clari PRIVATE "${API_SOURCE}")
target_include_directories("${API_TARGET}" SYSTEM BEFORE PRIVATE ${Boost_INCLUDE_DIRS})
target_link_libraries("${API_TARGET}" PUBLIC "${CLARICPP}" PUBLIC "${Z3_LINK_TARGET}" PUBLIC "${GMP_LIBRARIES}")

# Code quality exceptions for auto-generated code
message(STATUS "Permitting and suppressing warnings for auto-generated code...")
set_source_files_properties(${API_SOURCE} PROPERTIES COMPILE_FLAGS "-Wno-error -w")
message("Autogenerated API code configured!")